# Using these modeling functions

This repository contains a convenience function that does data analysis, or experiment end detection, on PlantD's measured data

Set up the following environment variables:

    - SCENARIO_NAME
        - namespace.name of the scenario used for the advanced simulation
    - SCENARIO_JSON
        - json dump of the scenario object to be simulated
    - NETCOST_NAME
        - json dump of the netcost object to be used
    - TWIN_NAME
        - namespace.name of the model to be constructed from the experiments
    - MODEL_TYPE
        - advanced_simple, or advanced_quickscaling
    - SIM_NAME
        - A name for the simulation to be run 
    - TRAFFIC_MODEL_NAME
        - The traffic model to use.  See samples directory for an example. 
        - This will be looked up from redis key `plantd:trafficmodel_params:$TRAFFIC_MODEL`
    - REDIS_HOST
    - REDIS_PASSWORD
    - PROMETHEUS_HOST
    - PROMETHEUS_PASSWORD
        - if missing, no password is sent
    - COST_PROMETHEUS_ENDPOINT  
        - This will eventually go away, when the opencost prometheus is merged with the windtunnel prometheus
    - OPENCOST_ENDPOINT
        - Endpoint of the opencost service
    - PIPELINE_LABEL_KEY
    - PIPELINE_LABEL_VALUE
        - Used by opencost.  Optional.
    - EXPERIMENT_NAMES
        - comma-separated list of namespace.name of each experiment generated by the scenario
    - EXPERIMENTS
        - json dictionary, where the keys are the names of experiments in the form namespace.name, and the values are the records containing describe information for all experiments generated by the secenario 
        - Note that experiments not listed in EXPERIMENT_NAMES will be omitted from analysis (so it's OK to dump every experiment here; they'll just be ignored)
        - See samples directory for an example
    - LOADPATTERNS
        - json dictionary of all load patterns mentioned in the EXPERIMENTS. 
        - Note that load patterns not listed in EXPERIMENTs will be ignored (so it's OK to dump all load patterns here; they'll just be ignored)
        - See samples directory for an example

2. *advanced_sim_all* To build and run a model from a scenario, a netcost file, and set of experiments alnd load patterns generated from the scenario, call `python make.py advanced_sim_all`.  
    - This writes the following to redis:
        - `plantd:trafficmodel_params:$TRAFFIC_MODEL`  copy of the traffic model passed in
        - `plantd:trafficmodel_prediction:$TRAFFIC_MODEL`
        - `plantd:twinmodel:$TWIN_NAME`  Parameters describing the digital twin created from the experiments
        - `plantd:experiment_cost:$EXPERIMENT_NAME`  Cache of cost logs retrieved from opencost
        - `plantd:metrics:$EXPERIMENT_NAME`  This will be a cache of data scraped from prometheus for each experiment (since prometheus data disappears after a few days)
        - `plantd:simulation_traffic:$SIM_NAME` contains a CSV string with a timeseries of all simulation results
        - `plantd:simulation_summary:$SIM_NAME` Contains summary of simulation data over the whole simluation year
    - If the experiment data in prometheus has already aged out (e.g. more than 3 days old), but the experiment has previously been used in a
        simulation, then the data can be used from the cache by calling `python make.py sim_all from_cached`.  (However, if you don't use from_cached, and it's
        aged out, it'll write 0's to the cache, and the data will be lost.  So we really need a better technique here.)
    - If the simulation succeeds, the script will print "SIMULATION_STATUS: Success"
    - If the simulation fails, the script will print "SIMULATION_STATUS: Failure" and "ERROR_REASON: <explanation>" 

3. *advanced_net_cost_only* calculates network costs, but does not attempt to simulate pipeine behavior



Sample files provided in this project, representing 3 traffic models, 3 experiments, and 9 (=3*3) simulations:
    - plantd:trafficmodel_params:traffic-model-low
    - plantd:trafficmodel_params:traffic-model-lowplus
    - plantd:trafficmodel_params:traffic-model-nominal
    - plantd:trafficmodel_predictions:traffic-model-low
    - plantd:trafficmodel_predictions:traffic-model-lowplus
    - plantd:trafficmodel_predictions:traffic-model-nominal
    - plantd:twinmodel:ubi-chris-test.chris-model-good-tri
    - plantd:twinmodel:ubi-chris-test.chris-model-bad-tri
    - plantd:twinmodel:ubi-chris-test.chris-model-fixed-tri
    - plantd:experiment_cost:ubi-chris-test.ubi-chris-test-good-triangle-3
    - plantd:experiment_cost:ubi-chris-test.ubi-chris-test-bad-triangle-3
    - plantd:experiment_cost:ubi-chris-test.ubi-chris-test-fixed-triangle-3
    - plantd:metrics:ubi-chris-test.ubi-chris-test-fixed-triangle-3
    - plantd:metrics:ubi-chris-test.ubi-chris-test-bad-triangle-3
    - plantd:metrics:ubi-chris-test.ubi-chris-test-good-triangle-3
    - plantd:simulation_traffic:test-lowplus-fixed-tri
    - plantd:simulation_traffic:test-low-fixed-tri
    - plantd:simulation_traffic:test-low-good-tri
    - plantd:simulation_traffic:test-lowplus-bad-tri
    - plantd:simulation_traffic:test-lowplus-good-tri
    - plantd:simulation_traffic:test-nom-fixed-tri
    - plantd:simulation_traffic:test-low-bad-tri
    - plantd:simulation_traffic:test-nom-good-tri
    - plantd:simulation_traffic:test-nom-bad-tri
    - plantd:simulation_summary:test-nom-bad-tri
    - plantd:simulation_summary:test-nom-good-tri
    - plantd:simulation_summary:test-low-bad-tri
    - plantd:simulation_summary:test-low-fixed-tri
    - plantd:simulation_summary:test-low-good-tri
    - plantd:simulation_summary:test-nom-fixed-tri
    - plantd:simulation_summary:test-lowplus-fixed-tri
    - plantd:simulation_summary:test-lowplus-good-tri
    - plantd:simulation_summary:test-lowplus-bad-tri

Plus these environment files that can be exported, then used to trigger simulations:
    - dev-env-build-test-low-bad-tri.env
    - dev-env-build-test-low-fixed-tri.env
    - dev-env-build-test-low-good-tri.env
    - dev-env-build-test-lowplus-bad-tri.env
    - dev-env-build-test-lowplus-fixed-tri.env
    - dev-env-build-test-lowplus-good-tri.env
    - dev-env-build-test-nom-bad-tri.env
    - dev-env-build-test-nom-fixed-tri.env
    - dev-env-build-test-nom-good-tri.env